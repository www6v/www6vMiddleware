<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="/// 对应了 Redis 的 save 命 令，会在 save 命令的实现函数 saveCommand(在 rdb.c 文件中)中被调用 /* Save the DB on disk. Return C_ERR on error, C_OK on success. */ int rdbSave(char *filename, rdbSaveInfo *rsi) { char tmpfile[256]; char cwd[MAXPATHLEN]; /* Current working dir path for error messages. */ FILE *fp; rio rdb; int error = 0; snprintf(tmpfile,256,&#34;temp-%d.rdb&#34;, (int) getpid()); fp = fopen(tmpfile,&#34;w&#34;); if (!fp) { char *cwdp = getcwd(cwd,MAXPATHLEN); serverLog(LL_WARNING, &#34;Failed opening the RDB file %s (in server root dir %s) &#34; &#34;for saving: %s&#34;, filename, cwdp ?">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://www6v.github.io/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/rdb/">
  <meta property="og:site_name" content="中间件">
  <meta property="og:title" content="Redis RDB源码">
  <meta property="og:description" content="/// 对应了 Redis 的 save 命 令，会在 save 命令的实现函数 saveCommand(在 rdb.c 文件中)中被调用 /* Save the DB on disk. Return C_ERR on error, C_OK on success. */ int rdbSave(char *filename, rdbSaveInfo *rsi) { char tmpfile[256]; char cwd[MAXPATHLEN]; /* Current working dir path for error messages. */ FILE *fp; rio rdb; int error = 0; snprintf(tmpfile,256,&#34;temp-%d.rdb&#34;, (int) getpid()); fp = fopen(tmpfile,&#34;w&#34;); if (!fp) { char *cwdp = getcwd(cwd,MAXPATHLEN); serverLog(LL_WARNING, &#34;Failed opening the RDB file %s (in server root dir %s) &#34; &#34;for saving: %s&#34;, filename, cwdp ?">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="website">
<title>Redis RDB源码 | 中间件</title>
<link rel="icon" href="/www6vMiddleware/favicon.png" >
<link rel="manifest" href="/www6vMiddleware/manifest.json">
<link rel="canonical" href="https://www6v.github.io/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/rdb/">
<link rel="stylesheet" href="/www6vMiddleware/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css" integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin="anonymous">
  <script defer src="/www6vMiddleware/fuse.min.js"></script>
  <script defer src="/www6vMiddleware/en.search.min.5c28fa2afbff1bf4c3323f774da325501c0a137dd04a5d5d7f318038481f3f9b.js" integrity="sha256-XCj6Kvv/G/TDMj93TaMlUBwKE33QSl1dfzGAOEgfP5s=" crossorigin="anonymous"></script>

  

<link rel="alternate" type="application/rss+xml" href="https://www6v.github.io/www6vMiddleware/docs/Redis+%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/rdb/index.xml" title="中间件" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/www6vMiddleware/"><span>中间件</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-b13c95c069c614e8c16265f1c191a430" class="toggle"  />
    <label for="section-b13c95c069c614e8c16265f1c191a430" class="flex justify-between">
      <a role="button" class="">服务治理</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Overview</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Overview/microservice/" class="">微服务 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Overview/soaFeature/" class="">分布式服务框架功能</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>API Gateway</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/API-Gateway/apiGatawaySpringGateway/" class="">API 网关-SpringCloud Gateway</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/API-Gateway/apiGatawayApisix/" class="">API 网关-apisix</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/API-Gateway/apiGateway/" class="">API Gateway网关</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Config &amp; Discovery</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/ConfigDiscovery/soaDiscovery/" class="">服务发现</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/ConfigDiscovery/config/" class="">服务治理-分布式配置</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>负载均衡</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/loadBalance/loadBalance/" class="">负载均衡-算法</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/loadBalance/nginxOptimize/" class="">Nginx优化</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/loadBalance/nginx/" class="">Nginx总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>线程模型</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/threadModel/jsfThreadModel/" class="">京东服务框架JSF服务提供者线程模型</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>容错&amp;限流</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>容错</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/faultTolerant/soaTolerateFramework/" class="">容错框架</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/faultTolerant/soaTimeout/" class="">超时和重试 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/faultTolerant/soaTolerate/" class="">分布式服务框架 容错机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>限流</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/throttle/ratelimitSentinel/" class="">流量治理-Sentinel</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/throttle/ratelimit/" class="">限流-总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/soaGracefulStart/" class="">优雅启动</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/soaGracefulClose/" class="">优雅关闭</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Spring Cloud</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springTransactionInvalid/" class="">Spring  Transaction  失效</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springCloud/" class="">SpringCloud</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springboot/" class="">SpringBoot</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springTransaction/" class="">Spring事务</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>灰度发布</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Gray/apiGatewayGray/" class="">API 网关-灰度发布</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>安全</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/security/soaAuth/" class="">服务治理-鉴权</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/security/securityOAuth2/" class="">安全-OAuth2</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-619f87396da4f22c9e982ebbcfb80a1d" class="toggle"  />
    <label for="section-619f87396da4f22c9e982ebbcfb80a1d" class="flex justify-between">
      <a role="button" class="">消息系统</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Overview</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Overview/mq/" class="">消息中间件总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Overview/mqCompare/" class="">MQ总结(Kafka, Rocketmq, Rabbitmq)</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Overview/mqOrdering/" class="">消息系统 顺序消息</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Kafka</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafka/" class="">Kafka总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaProducer/" class="">Kafka Producer生产者</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaConsumer/" class="">Kafka消费者总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaRebalance/" class="">Kafka消费者-Rebalance机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaReliability/" class="">Kafka 可靠性总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaIndex/" class="">Kafka 索引</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaZeroCopy/" class="">Kafka-ZeroCopy</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaController/" class="">Kafka Controller-控制器</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaReplica/" class="">Kafka Replication-副本机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaElection/" class="">Kafka 中的选主</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaQ-A/" class="">Kafka  Q&amp;A</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaTransaction/" class="">Kafka 幂等性和事务</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-c8ef6724255360cd9e1bb212713f9134" class="toggle"  />
    <label for="section-c8ef6724255360cd9e1bb212713f9134" class="flex justify-between">
      <a role="button" class="">关系型数据库</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>单机</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlTransactionAndLock/" class="">MySQL 事务-隔离性</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlUpdate/" class="">MySQL中的SQL更新语句</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlReliability/" class="">MySQL的主从 高可用 容灾</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlIndex/" class="">MySQL的索引和优化</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlTransaction/" class="">MySQL事务-总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlLog/" class="">MySQL Logs</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlDeadLock/" class="">MySQL  锁和死锁</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlMasterSlaveDelay/" class="">MySQL 主从延迟</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>分布式</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/distributedDatabase/" class="">分布式 数据库 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/distributedDatabaseCompare/" class="">分布式 数据库 比较</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/tikvMVCCTransaction/" class="">TiKV Transaction-MVCC&#43;TSO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/distributedDatabaseGlobalTime/" class="">分布式数据库-全局时钟</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/distributedDatabaseJoinQuery/" class="">数据库  关联查询</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/globalSecondaryIndex/" class="">全局二级索引-GSI</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-10fff53c331fc90701f5c89a3d268231" class="toggle" checked />
    <label for="section-10fff53c331fc90701f5c89a3d268231" class="flex justify-between">
      <a role="button" class="">Redis&#43;缓存</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Redis 基础</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>overview</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/overview/redis/" class="">Redis 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/overview/redisIO/" class="">Redis 的IO模型</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Arch &amp; Redis Cluster</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/Arch-Redis-Cluster/redisArch/" class="">Redis 架构</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/Arch-Redis-Cluster/redisError/" class="">Redis Error-MOVED和ASK指令</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/Arch-Redis-Cluster/redisCluster/" class="">Redis Cluster</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/Arch-Redis-Cluster/redisClusterSpec/" class="">Redis Cluster Spec</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/Arch-Redis-Cluster/redisHA/" class="">Redis 集群  容灾（同城多活）</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>数据类型</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/redisRehash/" class="">Redis Rehash机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/redisDataStructure/" class="">Redis数据结构</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>事务</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1/redisTransaction/" class="">Redis 事务</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>持久化</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/redisBothAofAndRDB/" class="">Redis 混合持久化</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/redisReplica/" class="">Redis 主从复制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/redisAOF/" class="">Redis AOF</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/rdb/" class="active">Redis RDB源码</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/aofRewrite/" class="">Redis AOF Rewrite</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/redisRDB/" class="">Redis RDB</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>资源回收</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E8%B5%84%E6%BA%90%E5%9B%9E%E6%94%B6/redisLazyFree/" class="">Redis LazyFree</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E8%B5%84%E6%BA%90%E5%9B%9E%E6%94%B6/redisDelete/" class="">Redis 回收策略</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E8%B5%84%E6%BA%90%E5%9B%9E%E6%94%B6/redisLRU/" class="">Redis LRU算法</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>其他</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E5%85%B6%E4%BB%96/redisNVM/" class="">Redis NVM</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Redis 故障&amp;优化</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>常见问题</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisBigKey/" class="">Redis 大Key</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisOptimize/" class="">Redis 优化建议</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisReliability-1/" class="">Redis雪崩、击穿、穿透</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisDbConsistent/" class="">Redis和数据库之间的一致性</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisSlowResponse/" class="">Redis 慢查询排查</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisHotkey/" class="">Redis 热点Hotkey</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisHitRate/" class="">Redis  命中率</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/redisNodeId/" class="">Redis 集群扩容时NodeId问题</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Redis 应用</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%BA%94%E7%94%A8/redisUseCase/" class="">Redis 使用场景UseCase</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%BA%94%E7%94%A8/redisSLO/" class="">Redis SLO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>缓存</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/%E7%BC%93%E5%AD%98/cacheConsistent/" class="">缓存 一致性</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/%E7%BC%93%E5%AD%98/cacheMultiLayer/" class="">多级缓存(cache)</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/%E7%BC%93%E5%AD%98/cacheSummary/" class="">缓存(cache)总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/%E7%BC%93%E5%AD%98/cache/" class="">缓存(cache)机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-32f9dc03750c220286c7473819bce980" class="toggle"  />
    <label for="section-32f9dc03750c220286c7473819bce980" class="flex justify-between">
      <a role="button" class="">可观察性</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-dc8f2f5497ce4108befe4e476516f176" class="toggle"  />
    <label for="section-dc8f2f5497ce4108befe4e476516f176" class="flex justify-between">
      <a role="button" class="">Overview</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Overview/observabilityBuilding/" class="">可观测性-系统构建</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Overview/observability/" class="">可观测性 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3043990ad08375eb7c9c6edfe028b695" class="toggle"  />
    <label for="section-3043990ad08375eb7c9c6edfe028b695" class="flex justify-between">
      <a role="button" class="">统一模型</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/%E7%BB%9F%E4%B8%80%E6%A8%A1%E5%9E%8B/observabilityOpenTelemetry/" class="">可观测性-OpenTelemetry</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-84e728d84c21d229850e75585c894763" class="toggle"  />
    <label for="section-84e728d84c21d229850e75585c894763" class="flex justify-between">
      <a role="button" class="">Tracing</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Tracing/observabilityTracing/" class="">可观测性-Tracing</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Tracing/observabilitySkywalking/" class="">可观测性-Skywalking</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b7783e9af3c62e3b112dcbbc90d53981" class="toggle"  />
    <label for="section-b7783e9af3c62e3b112dcbbc90d53981" class="flex justify-between">
      <a role="button" class="">Metric</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Metric/observabilityPrometheusBiz/" class="">可观测性-Prometheus业务监控</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-096d1f91bb8cc7509e2398164079cfc3" class="toggle"  />
    <label for="section-096d1f91bb8cc7509e2398164079cfc3" class="flex justify-between">
      <a role="button" class="">Log</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Log/observabilityLog/" class="">可观测性-Log</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-13a7e93d081a3f31bedaa6f5a5dbc6b9" class="toggle"  />
    <label for="section-13a7e93d081a3f31bedaa6f5a5dbc6b9" class="flex justify-between">
      <a role="button" class="">DAL</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/DAL/dbShardingPaging/" class="">分库分表-分页</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/DAL/dbReadWrite/" class="">数据库-读写分离</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/DAL/dbSharding/" class="">分库分表</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/DAL/mybatisInteceptor/" class="">Mybatis Plugin Inteceptor</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-8f9194d3152193bbfc8d905f93eb7238" class="toggle"  />
    <label for="section-8f9194d3152193bbfc8d905f93eb7238" class="flex justify-between">
      <a role="button" class="">分布式锁</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/redisDistKey/" class="">Redis 分布式锁</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/zookeeperDistributedLock/" class="">Zookeeper-分布式锁</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/distributedLock/" class="">分布式锁</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-35ef217d212df8f7f126510047a2ffcd" class="toggle"  />
    <label for="section-35ef217d212df8f7f126510047a2ffcd" class="flex justify-between">
      <a role="button" class="">其他</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/transactionSeata/" class="">Seata 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/event/" class="">事件 Event</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/tomcat/" class="">Tomcat总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/timedTask/" class="">延迟消息 时间轮</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/id/" class="">分布式ID生成 发号器</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/zookeeper/" class="">Zookeeper-总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-d4607dec705229c566e3d7c05dcf0a7c" class="toggle"  />
    <label for="section-d4607dec705229c566e3d7c05dcf0a7c" class="flex justify-between">
      <a role="button" class="">网络</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E7%BD%91%E7%BB%9C/grpc/" class="">gRPC</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E7%BD%91%E7%BB%9C/https/" class="">HTTP和HTTPS总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/www6vMiddleware/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Redis RDB源码</h3>

  <label for="toc-control">
    
    <img src="/www6vMiddleware/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#参考">参考：</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><p hidden></p>
<!-- more -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/// 对应了 Redis 的 save 命 令，会在 save 命令的实现函数 saveCommand(在 rdb.c 文件中)中被调用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/* Save the DB on disk. Return C_ERR on error, C_OK on success. */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rdbSave</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>filename, rdbSaveInfo <span style="color:#f92672">*</span>rsi) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> tmpfile[<span style="color:#ae81ff">256</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> cwd[MAXPATHLEN]; <span style="color:#75715e">/* Current working dir path for error messages. */</span>
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>fp;
</span></span><span style="display:flex;"><span>    rio rdb;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> error <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">snprintf</span>(tmpfile,<span style="color:#ae81ff">256</span>,<span style="color:#e6db74">&#34;temp-%d.rdb&#34;</span>, (<span style="color:#66d9ef">int</span>) <span style="color:#a6e22e">getpid</span>());
</span></span><span style="display:flex;"><span>    fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(tmpfile,<span style="color:#e6db74">&#34;w&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>fp) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cwdp <span style="color:#f92672">=</span> <span style="color:#a6e22e">getcwd</span>(cwd,MAXPATHLEN);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">serverLog</span>(LL_WARNING,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Failed opening the RDB file %s (in server root dir %s) &#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;for saving: %s&#34;</span>,
</span></span><span style="display:flex;"><span>            filename,
</span></span><span style="display:flex;"><span>            cwdp <span style="color:#f92672">?</span> cwdp : <span style="color:#e6db74">&#34;unknown&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">strerror</span>(errno));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> C_ERR;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rioInitWithFile</span>(<span style="color:#f92672">&amp;</span>rdb,fp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (server.rdb_save_incremental_fsync)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rioSetAutoSync</span>(<span style="color:#f92672">&amp;</span>rdb,REDIS_AUTOSYNC_BYTES);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">rdbSaveRio</span>(<span style="color:#f92672">&amp;</span>rdb,<span style="color:#f92672">&amp;</span>error,RDB_SAVE_NONE,rsi) <span style="color:#f92672">==</span> C_ERR) {. <span style="color:#75715e">/// 调用 rdbSaveRio 函数(在 rdb.c 文件中)来实际创建 RDB 文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        errno <span style="color:#f92672">=</span> error;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> werr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Make sure data will not remain on the OS&#39;s output buffers */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fflush</span>(fp) <span style="color:#f92672">==</span> EOF) <span style="color:#66d9ef">goto</span> werr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fsync</span>(<span style="color:#a6e22e">fileno</span>(fp)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">goto</span> werr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fclose</span>(fp) <span style="color:#f92672">==</span> EOF) <span style="color:#66d9ef">goto</span> werr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Use RENAME to make sure the DB file is changed atomically only
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * if the generate DB file is ok. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">rename</span>(tmpfile,filename) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cwdp <span style="color:#f92672">=</span> <span style="color:#a6e22e">getcwd</span>(cwd,MAXPATHLEN);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">serverLog</span>(LL_WARNING,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Error moving temp DB file %s on the final &#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;destination %s (in server root dir %s): %s&#34;</span>,
</span></span><span style="display:flex;"><span>            tmpfile,
</span></span><span style="display:flex;"><span>            filename,
</span></span><span style="display:flex;"><span>            cwdp <span style="color:#f92672">?</span> cwdp : <span style="color:#e6db74">&#34;unknown&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">strerror</span>(errno));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlink</span>(tmpfile);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> C_ERR;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">serverLog</span>(LL_NOTICE,<span style="color:#e6db74">&#34;DB saved on disk&#34;</span>);
</span></span><span style="display:flex;"><span>    server.dirty <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    server.lastsave <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>(NULL);
</span></span><span style="display:flex;"><span>    server.lastbgsave_status <span style="color:#f92672">=</span> C_OK;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> C_OK;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>werr:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">serverLog</span>(LL_WARNING,<span style="color:#e6db74">&#34;Write error saving DB on disk: %s&#34;</span>, <span style="color:#a6e22e">strerror</span>(errno));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(fp);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">unlink</span>(tmpfile);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> C_ERR;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/// 对应 了 Redis 的 bgsave 命令，会在 bgsave 命令的实现函数 bgsaveCommand(在 rdb.c 文 件中)中被调用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rdbSaveBackground</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>filename, rdbSaveInfo <span style="color:#f92672">*</span>rsi) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pid_t</span> childpid;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> start;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (server.aof_child_pid <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> server.rdb_child_pid <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> C_ERR;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    server.dirty_before_bgsave <span style="color:#f92672">=</span> server.dirty;
</span></span><span style="display:flex;"><span>    server.lastbgsave_try <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>(NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">openChildInfoPipe</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> <span style="color:#a6e22e">ustime</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((childpid <span style="color:#f92672">=</span> <span style="color:#a6e22e">fork</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {  <span style="color:#75715e">/// 子进程的代码执行分支
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> retval;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Child */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">closeClildUnusedResourceAfterFork</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">redisSetProcTitle</span>(<span style="color:#e6db74">&#34;redis-rdb-bgsave&#34;</span>);
</span></span><span style="display:flex;"><span>        retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdbSave</span>(filename,rsi);   <span style="color:#75715e">///  调用rdbSave函数创建RDB文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (retval <span style="color:#f92672">==</span> C_OK) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">size_t</span> private_dirty <span style="color:#f92672">=</span> <span style="color:#a6e22e">zmalloc_get_private_dirty</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (private_dirty) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">serverLog</span>(LL_NOTICE,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;RDB: %zu MB of memory used by copy-on-write&#34;</span>,
</span></span><span style="display:flex;"><span>                    private_dirty<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1024</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1024</span>));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            server.child_info_data.cow_size <span style="color:#f92672">=</span> private_dirty;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sendChildInfo</span>(CHILD_INFO_TYPE_RDB);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exitFromChild</span>((retval <span style="color:#f92672">==</span> C_OK) <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>);   <span style="color:#75715e">///  子进程退出
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Parent */</span>    <span style="color:#75715e">//父进程代码执行分支
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        server.stat_fork_time <span style="color:#f92672">=</span> <span style="color:#a6e22e">ustime</span>()<span style="color:#f92672">-</span>start;
</span></span><span style="display:flex;"><span>        server.stat_fork_rate <span style="color:#f92672">=</span> (<span style="color:#66d9ef">double</span>) <span style="color:#a6e22e">zmalloc_used_memory</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000000</span> <span style="color:#f92672">/</span> server.stat_fork_time <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1024</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1024</span>); <span style="color:#75715e">/* GB per second. */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">latencyAddSampleIfNeeded</span>(<span style="color:#e6db74">&#34;fork&#34;</span>,server.stat_fork_time<span style="color:#f92672">/</span><span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (childpid <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">closeChildInfoPipe</span>();
</span></span><span style="display:flex;"><span>            server.lastbgsave_status <span style="color:#f92672">=</span> C_ERR;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">serverLog</span>(LL_WARNING,<span style="color:#e6db74">&#34;Can&#39;t save in background: fork: %s&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">strerror</span>(errno));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> C_ERR;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">serverLog</span>(LL_NOTICE,<span style="color:#e6db74">&#34;Background saving started by pid %d&#34;</span>,childpid);
</span></span><span style="display:flex;"><span>        server.rdb_save_time_start <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>(NULL);
</span></span><span style="display:flex;"><span>        server.rdb_child_pid <span style="color:#f92672">=</span> childpid;
</span></span><span style="display:flex;"><span>        server.rdb_child_type <span style="color:#f92672">=</span> RDB_CHILD_TYPE_DISK;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">updateDictResizePolicy</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> C_OK;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> C_OK; <span style="color:#75715e">/* unreached */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/// 这是 Redis server 在采用不落盘方式传输 RDB 文件进行主从复制时，创建 RDB 文件的入 口函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/// rdbSaveToSlavesSockets 函数是通过网络以字节流的形式，直接发送 RDB 文件的二进制 数据给从节点。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/* Spawn an RDB child that writes the RDB to the sockets of the slaves
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * that are currently in SLAVE_STATE_WAIT_BGSAVE_START state. */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rdbSaveToSlavesSockets</span>(rdbSaveInfo <span style="color:#f92672">*</span>rsi) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>fds;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> <span style="color:#f92672">*</span>clientids;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> numfds;
</span></span><span style="display:flex;"><span>    listNode <span style="color:#f92672">*</span>ln;
</span></span><span style="display:flex;"><span>    listIter li;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pid_t</span> childpid;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> start;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> pipefds[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (server.aof_child_pid <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> server.rdb_child_pid <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> C_ERR;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Before to fork, create a pipe that will be used in order to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * send back to the parent the IDs of the slaves that successfully
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * received all the writes. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pipe</span>(pipefds) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> C_ERR;
</span></span><span style="display:flex;"><span>    server.rdb_pipe_read_result_from_child <span style="color:#f92672">=</span> pipefds[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    server.rdb_pipe_write_result_to_parent <span style="color:#f92672">=</span> pipefds[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Collect the file descriptors of the slaves we want to transfer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * the RDB to, which are i WAIT_BGSAVE_START state. */</span>
</span></span><span style="display:flex;"><span>    fds <span style="color:#f92672">=</span> <span style="color:#a6e22e">zmalloc</span>(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">listLength</span>(server.slaves));
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* We also allocate an array of corresponding client IDs. This will
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * be useful for the child process in order to build the report
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * (sent via unix pipe) that will be sent to the parent. */</span>
</span></span><span style="display:flex;"><span>    clientids <span style="color:#f92672">=</span> <span style="color:#a6e22e">zmalloc</span>(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint64_t</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">listLength</span>(server.slaves));
</span></span><span style="display:flex;"><span>    numfds <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">listRewind</span>(server.slaves,<span style="color:#f92672">&amp;</span>li);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>((ln <span style="color:#f92672">=</span> <span style="color:#a6e22e">listNext</span>(<span style="color:#f92672">&amp;</span>li))) {
</span></span><span style="display:flex;"><span>        client <span style="color:#f92672">*</span>slave <span style="color:#f92672">=</span> ln<span style="color:#f92672">-&gt;</span>value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (slave<span style="color:#f92672">-&gt;</span>replstate <span style="color:#f92672">==</span> SLAVE_STATE_WAIT_BGSAVE_START) {
</span></span><span style="display:flex;"><span>            clientids[numfds] <span style="color:#f92672">=</span> slave<span style="color:#f92672">-&gt;</span>id;
</span></span><span style="display:flex;"><span>            fds[numfds<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> slave<span style="color:#f92672">-&gt;</span>fd;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">replicationSetupSlaveForFullResync</span>(slave,<span style="color:#a6e22e">getPsyncInitialOffset</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* Put the socket in blocking mode to simplify RDB transfer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * We&#39;ll restore it when the children returns (since duped socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * will share the O_NONBLOCK attribute with the parent). */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">anetBlock</span>(NULL,slave<span style="color:#f92672">-&gt;</span>fd);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">anetSendTimeout</span>(NULL,slave<span style="color:#f92672">-&gt;</span>fd,server.repl_timeout<span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Create the child process. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">openChildInfoPipe</span>();
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> <span style="color:#a6e22e">ustime</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((childpid <span style="color:#f92672">=</span> <span style="color:#a6e22e">fork</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Child */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> retval;
</span></span><span style="display:flex;"><span>        rio slave_sockets;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rioInitWithFdset</span>(<span style="color:#f92672">&amp;</span>slave_sockets,fds,numfds);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">zfree</span>(fds);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">closeClildUnusedResourceAfterFork</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">redisSetProcTitle</span>(<span style="color:#e6db74">&#34;redis-rdb-to-slaves&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">rdbSaveRioWithEOFMark</span>(<span style="color:#f92672">&amp;</span>slave_sockets,NULL,rsi);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (retval <span style="color:#f92672">==</span> C_OK <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">rioFlush</span>(<span style="color:#f92672">&amp;</span>slave_sockets) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            retval <span style="color:#f92672">=</span> C_ERR;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (retval <span style="color:#f92672">==</span> C_OK) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">size_t</span> private_dirty <span style="color:#f92672">=</span> <span style="color:#a6e22e">zmalloc_get_private_dirty</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (private_dirty) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">serverLog</span>(LL_NOTICE,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;RDB: %zu MB of memory used by copy-on-write&#34;</span>,
</span></span><span style="display:flex;"><span>                    private_dirty<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1024</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1024</span>));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            server.child_info_data.cow_size <span style="color:#f92672">=</span> private_dirty;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sendChildInfo</span>(CHILD_INFO_TYPE_RDB);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* If we are returning OK, at least one slave was served
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * with the RDB file as expected, so we need to send a report
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * to the parent via the pipe. The format of the message is:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * &lt;len&gt; &lt;slave[0].id&gt; &lt;slave[0].error&gt; ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * len, slave IDs, and slave errors, are all uint64_t integers,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * so basically the reply is composed of 64 bits for the len field
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * plus 2 additional 64 bit integers for each entry, for a total
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * of &#39;len&#39; entries.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * The &#39;id&#39; represents the slave&#39;s client ID, so that the master
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * can match the report with a specific slave, and &#39;error&#39; is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * set to 0 if the replication process terminated with a success
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * or the error code if an error occurred. */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>msg <span style="color:#f92672">=</span> <span style="color:#a6e22e">zmalloc</span>(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint64_t</span>)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>numfds));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">uint64_t</span> <span style="color:#f92672">*</span>len <span style="color:#f92672">=</span> msg;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">uint64_t</span> <span style="color:#f92672">*</span>ids <span style="color:#f92672">=</span> len<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> j, msglen;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>len <span style="color:#f92672">=</span> numfds;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> numfds; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">*</span>ids<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> clientids[j];
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">*</span>ids<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> slave_sockets.io.fdset.state[j];
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* Write the message to the parent. If we have no good slaves or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * we are unable to transfer the message to the parent, we exit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * with an error so that the parent will abort the replication
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * process with all the childre that were waiting. */</span>
</span></span><span style="display:flex;"><span>            msglen <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint64_t</span>)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>numfds);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>len <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">write</span>(server.rdb_pipe_write_result_to_parent,msg,msglen)
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">!=</span> msglen)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                retval <span style="color:#f92672">=</span> C_ERR;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">zfree</span>(msg);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">zfree</span>(clientids);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rioFreeFdset</span>(<span style="color:#f92672">&amp;</span>slave_sockets);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exitFromChild</span>((retval <span style="color:#f92672">==</span> C_OK) <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Parent */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (childpid <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">serverLog</span>(LL_WARNING,<span style="color:#e6db74">&#34;Can&#39;t save in background: fork: %s&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">strerror</span>(errno));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* Undo the state change. The caller will perform cleanup on
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * all the slaves in BGSAVE_START state, but an early call to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * replicationSetupSlaveForFullResync() turned it into BGSAVE_END */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">listRewind</span>(server.slaves,<span style="color:#f92672">&amp;</span>li);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span>((ln <span style="color:#f92672">=</span> <span style="color:#a6e22e">listNext</span>(<span style="color:#f92672">&amp;</span>li))) {
</span></span><span style="display:flex;"><span>                client <span style="color:#f92672">*</span>slave <span style="color:#f92672">=</span> ln<span style="color:#f92672">-&gt;</span>value;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> j;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> (j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> numfds; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (slave<span style="color:#f92672">-&gt;</span>id <span style="color:#f92672">==</span> clientids[j]) {
</span></span><span style="display:flex;"><span>                        slave<span style="color:#f92672">-&gt;</span>replstate <span style="color:#f92672">=</span> SLAVE_STATE_WAIT_BGSAVE_START;
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">close</span>(pipefds[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">close</span>(pipefds[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">closeChildInfoPipe</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            server.stat_fork_time <span style="color:#f92672">=</span> <span style="color:#a6e22e">ustime</span>()<span style="color:#f92672">-</span>start;
</span></span><span style="display:flex;"><span>            server.stat_fork_rate <span style="color:#f92672">=</span> (<span style="color:#66d9ef">double</span>) <span style="color:#a6e22e">zmalloc_used_memory</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000000</span> <span style="color:#f92672">/</span> server.stat_fork_time <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1024</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1024</span>); <span style="color:#75715e">/* GB per second. */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">latencyAddSampleIfNeeded</span>(<span style="color:#e6db74">&#34;fork&#34;</span>,server.stat_fork_time<span style="color:#f92672">/</span><span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">serverLog</span>(LL_NOTICE,<span style="color:#e6db74">&#34;Background RDB transfer started by pid %d&#34;</span>,
</span></span><span style="display:flex;"><span>                childpid);
</span></span><span style="display:flex;"><span>            server.rdb_save_time_start <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>(NULL);
</span></span><span style="display:flex;"><span>            server.rdb_child_pid <span style="color:#f92672">=</span> childpid;
</span></span><span style="display:flex;"><span>            server.rdb_child_type <span style="color:#f92672">=</span> RDB_CHILD_TYPE_SOCKET;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">updateDictResizePolicy</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">zfree</span>(clientids);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">zfree</span>(fds);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (childpid <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> C_ERR : C_OK;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> C_OK; <span style="color:#75715e">/* Unreached. */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="./images/rdb.png" alt="rdb流程" /></p>
<h2 id="参考">
  参考：
  <a class="anchor" href="#%e5%8f%82%e8%80%83">#</a>
</h2>
<p>18 | 如何生成和解读RDB文件?<br>
《Redis源码剖析与实战》</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#参考">参考：</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












