<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="场景 [1]#场景一：客户端执行的显示删除/清除命令，比如 del，flushdb 等； 场景二：某些指令带有的隐式删除命令，比如 move , rename 等； 场景三：到达过期时间的数据需要删除； 场景四：使用内存达到 maxmemory 后被选出来要淘汰的数据需要删除； 场景五：在主从同步全量同步阶段，从库收到主库的 RDB 文件后要先删除现有的数据再加载 RDB 文件； 相关配置#惰性删除相 关的配置项 lazyfree-lazy-eviction：对应缓存淘汰时的数据删除场景。 lazyfree-lazy-expire：对应过期 key 的删除场景。 lazyfree-lazy-server-del：对应会隐式进行删除操作的 server 命令执行场景。 replica-lazy-flush：对应从节点完成全量同步后，删除原有旧数据的场景。 源代码#evict.c int freeMemoryIfNeeded(void) { /*......*/ /* Finally remove the selected key. */ if (bestkey) { db = server.db&#43;bestdbid; robj *keyobj = createStringObject(bestkey,sdslen(bestkey)); propagateExpire(db,keyobj,server.lazyfree_lazy_eviction); ### 1 /* We compute the amount of memory freed by db*Delete() alone.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://www6v.github.io/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E8%B5%84%E6%BA%90%E5%9B%9E%E6%94%B6/redisLazyFree/">
  <meta property="og:site_name" content="中间件">
  <meta property="og:title" content="Redis LazyFree">
  <meta property="og:description" content="场景 [1]#场景一：客户端执行的显示删除/清除命令，比如 del，flushdb 等； 场景二：某些指令带有的隐式删除命令，比如 move , rename 等； 场景三：到达过期时间的数据需要删除； 场景四：使用内存达到 maxmemory 后被选出来要淘汰的数据需要删除； 场景五：在主从同步全量同步阶段，从库收到主库的 RDB 文件后要先删除现有的数据再加载 RDB 文件； 相关配置#惰性删除相 关的配置项 lazyfree-lazy-eviction：对应缓存淘汰时的数据删除场景。 lazyfree-lazy-expire：对应过期 key 的删除场景。 lazyfree-lazy-server-del：对应会隐式进行删除操作的 server 命令执行场景。 replica-lazy-flush：对应从节点完成全量同步后，删除原有旧数据的场景。 源代码#evict.c int freeMemoryIfNeeded(void) { /*......*/ /* Finally remove the selected key. */ if (bestkey) { db = server.db&#43;bestdbid; robj *keyobj = createStringObject(bestkey,sdslen(bestkey)); propagateExpire(db,keyobj,server.lazyfree_lazy_eviction); ### 1 /* We compute the amount of memory freed by db*Delete() alone.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="website">
<title>Redis LazyFree | 中间件</title>
<link rel="icon" href="/www6vMiddleware/favicon.png" >
<link rel="manifest" href="/www6vMiddleware/manifest.json">
<link rel="canonical" href="https://www6v.github.io/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E8%B5%84%E6%BA%90%E5%9B%9E%E6%94%B6/redisLazyFree/">
<link rel="stylesheet" href="/www6vMiddleware/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css" integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin="anonymous">
  <script defer src="/www6vMiddleware/fuse.min.js"></script>
  <script defer src="/www6vMiddleware/en.search.min.85fb5441404d94b32dcb25662c3e295252384bea940e4b2d364651b043791637.js" integrity="sha256-hftUQUBNlLMtyyVmLD4pUlI4S&#43;qUDkstNkZRsEN5Fjc=" crossorigin="anonymous"></script>

  

<link rel="alternate" type="application/rss+xml" href="https://www6v.github.io/www6vMiddleware/docs/Redis+%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E8%B5%84%E6%BA%90%E5%9B%9E%E6%94%B6/redisLazyFree/index.xml" title="中间件" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/www6vMiddleware/"><span>中间件</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-b13c95c069c614e8c16265f1c191a430" class="toggle"  />
    <label for="section-b13c95c069c614e8c16265f1c191a430" class="flex justify-between">
      <a role="button" class="">服务治理</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Overview</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Overview/microservice/" class="">微服务 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Overview/soaFeature/" class="">分布式服务框架功能</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>API Gateway</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/API-Gateway/apiGatawaySpringGateway/" class="">API 网关-SpringCloud Gateway</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/API-Gateway/apiGatawayApisix/" class="">API 网关-apisix</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/API-Gateway/apiGateway/" class="">API Gateway网关</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Config &amp; Discovery</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/ConfigDiscovery/soaDiscovery/" class="">服务发现</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/ConfigDiscovery/config/" class="">服务治理-分布式配置</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>负载均衡</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/loadBalance/loadBalance/" class="">负载均衡-算法</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/loadBalance/nginxOptimize/" class="">Nginx优化</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/loadBalance/nginx/" class="">Nginx总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>线程模型</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/threadModel/jsfThreadModel/" class="">京东服务框架JSF服务提供者线程模型</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>容错&amp;限流</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>容错</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/faultTolerant/soaTolerateFramework/" class="">容错框架</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/faultTolerant/soaTimeout/" class="">超时和重试 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/faultTolerant/soaTolerate/" class="">分布式服务框架 容错机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>限流</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/throttle/ratelimitSentinel/" class="">流量治理-Sentinel</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/throttle/ratelimit/" class="">限流-总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/soaGracefulStart/" class="">优雅启动</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/soaGracefulClose/" class="">优雅关闭</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Spring Cloud</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springTransactionInvalid/" class="">Spring  Transaction  失效</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springCloud/" class="">SpringCloud</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springboot/" class="">SpringBoot</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springTransaction/" class="">Spring事务</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>灰度发布</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Gray/apiGatewayGray/" class="">API 网关-灰度发布</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>安全</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/security/soaAuth/" class="">服务治理-鉴权</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/security/securityOAuth2/" class="">安全-OAuth2</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-619f87396da4f22c9e982ebbcfb80a1d" class="toggle"  />
    <label for="section-619f87396da4f22c9e982ebbcfb80a1d" class="flex justify-between">
      <a role="button" class="">消息系统</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Overview</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Overview/mq/" class="">消息中间件总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Overview/mqCompare/" class="">MQ总结(Kafka, Rocketmq, Rabbitmq)</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Overview/mqOrdering/" class="">消息系统 顺序消息</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Kafka</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafka/" class="">Kafka总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaProducer/" class="">Kafka Producer生产者</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaConsumer/" class="">Kafka消费者总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaRebalance/" class="">Kafka消费者-Rebalance机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaReliability/" class="">Kafka 可靠性总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaIndex/" class="">Kafka 索引</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaZeroCopy/" class="">Kafka-ZeroCopy</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaController/" class="">Kafka Controller-控制器</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaReplica/" class="">Kafka Replication-副本机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaElection/" class="">Kafka 中的选主</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaQ-A/" class="">Kafka  Q&amp;A</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaTransaction/" class="">Kafka 幂等性和事务</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-c8ef6724255360cd9e1bb212713f9134" class="toggle"  />
    <label for="section-c8ef6724255360cd9e1bb212713f9134" class="flex justify-between">
      <a role="button" class="">关系型数据库</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>单机</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlTransactionAndLock/" class="">MySQL 事务-隔离性</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlUpdate/" class="">MySQL中的SQL更新语句</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlReliability/" class="">MySQL的主从 高可用 容灾</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlIndex/" class="">MySQL的索引和优化</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlTransaction/" class="">MySQL事务-总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlLog/" class="">MySQL Logs</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlDeadLock/" class="">MySQL  锁和死锁</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlMasterSlaveDelay/" class="">MySQL 主从延迟</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>分布式</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/distributedDatabase/" class="">分布式 数据库 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/distributedDatabaseCompare/" class="">分布式 数据库 比较</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/tikvMVCCTransaction/" class="">TiKV Transaction-MVCC&#43;TSO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/distributedDatabaseGlobalTime/" class="">分布式数据库-全局时钟</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/distributedDatabaseJoinQuery/" class="">数据库  关联查询</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%88%86%E5%B8%83%E5%BC%8F/globalSecondaryIndex/" class="">全局二级索引-GSI</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-10fff53c331fc90701f5c89a3d268231" class="toggle" checked />
    <label for="section-10fff53c331fc90701f5c89a3d268231" class="flex justify-between">
      <a role="button" class="">Redis&#43;缓存</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Redis 基础</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>overview</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/overview/redis/" class="">Redis 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/overview/redisIO/" class="">Redis 的IO模型</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Arch &amp; Redis Cluster</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/Arch-Redis-Cluster/redisArch/" class="">Redis 架构</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/Arch-Redis-Cluster/redisError/" class="">Redis Error-MOVED和ASK指令</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/Arch-Redis-Cluster/redisCluster/" class="">Redis Cluster</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/Arch-Redis-Cluster/redisClusterSpec/" class="">Redis Cluster Spec</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/Arch-Redis-Cluster/redisHA/" class="">Redis 集群  容灾（同城多活）</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>数据类型</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/redisRehash/" class="">Redis Rehash机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/redisDataStructure/" class="">Redis数据结构</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>事务</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E4%BA%8B%E5%8A%A1/redisTransaction/" class="">Redis 事务</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>持久化</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/redisBothAofAndRDB/" class="">Redis 混合持久化</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/redisReplica/" class="">Redis 主从复制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/redisAOF/" class="">Redis AOF</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/rdb/" class="">Redis RDB源码</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/aofRewrite/" class="">Redis AOF Rewrite</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E6%8C%81%E4%B9%85%E5%8C%96/redisRDB/" class="">Redis RDB</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>资源回收</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E8%B5%84%E6%BA%90%E5%9B%9E%E6%94%B6/redisLazyFree/" class="active">Redis LazyFree</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E8%B5%84%E6%BA%90%E5%9B%9E%E6%94%B6/redisDelete/" class="">Redis 回收策略</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E8%B5%84%E6%BA%90%E5%9B%9E%E6%94%B6/redisLRU/" class="">Redis LRU算法</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>其他</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%9F%BA%E7%A1%80/%E5%85%B6%E4%BB%96/redisNVM/" class="">Redis NVM</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Redis 故障&amp;优化</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>常见问题</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisBigKey/" class="">Redis 大Key</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisOptimize/" class="">Redis 优化建议</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisReliability-1/" class="">Redis雪崩、击穿、穿透</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisDbConsistent/" class="">Redis和数据库之间的一致性</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisSlowResponse/" class="">Redis 慢查询排查</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisHotkey/" class="">Redis 热点Hotkey</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/redisHitRate/" class="">Redis  命中率</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E6%95%85%E9%9A%9C%E4%BC%98%E5%8C%96/redisNodeId/" class="">Redis 集群扩容时NodeId问题</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Redis 应用</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%BA%94%E7%94%A8/redisUseCase/" class="">Redis 使用场景UseCase</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/Redis-%E5%BA%94%E7%94%A8/redisSLO/" class="">Redis SLO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>缓存</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/%E7%BC%93%E5%AD%98/cacheConsistent/" class="">缓存 一致性</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/%E7%BC%93%E5%AD%98/cacheMultiLayer/" class="">多级缓存(cache)</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/%E7%BC%93%E5%AD%98/cacheSummary/" class="">缓存(cache)总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Redis&#43;%E7%BC%93%E5%AD%98/%E7%BC%93%E5%AD%98/cache/" class="">缓存(cache)机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-32f9dc03750c220286c7473819bce980" class="toggle"  />
    <label for="section-32f9dc03750c220286c7473819bce980" class="flex justify-between">
      <a role="button" class="">可观察性</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-dc8f2f5497ce4108befe4e476516f176" class="toggle"  />
    <label for="section-dc8f2f5497ce4108befe4e476516f176" class="flex justify-between">
      <a role="button" class="">Overview</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Overview/observabilityBuilding/" class="">可观测性-系统构建</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Overview/observability/" class="">可观测性 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3043990ad08375eb7c9c6edfe028b695" class="toggle"  />
    <label for="section-3043990ad08375eb7c9c6edfe028b695" class="flex justify-between">
      <a role="button" class="">统一模型</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/%E7%BB%9F%E4%B8%80%E6%A8%A1%E5%9E%8B/observabilityOpenTelemetry/" class="">可观测性-OpenTelemetry</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-84e728d84c21d229850e75585c894763" class="toggle"  />
    <label for="section-84e728d84c21d229850e75585c894763" class="flex justify-between">
      <a role="button" class="">Tracing</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Tracing/observabilityTracing/" class="">可观测性-Tracing</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Tracing/observabilitySkywalking/" class="">可观测性-Skywalking</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b7783e9af3c62e3b112dcbbc90d53981" class="toggle"  />
    <label for="section-b7783e9af3c62e3b112dcbbc90d53981" class="flex justify-between">
      <a role="button" class="">Metric</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Metric/observabilityPrometheusBiz/" class="">可观测性-Prometheus业务监控</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-096d1f91bb8cc7509e2398164079cfc3" class="toggle"  />
    <label for="section-096d1f91bb8cc7509e2398164079cfc3" class="flex justify-between">
      <a role="button" class="">Log</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/Observe/Log/observabilityLog/" class="">可观测性-Log</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-13a7e93d081a3f31bedaa6f5a5dbc6b9" class="toggle"  />
    <label for="section-13a7e93d081a3f31bedaa6f5a5dbc6b9" class="flex justify-between">
      <a role="button" class="">DAL</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/DAL/dbShardingPaging/" class="">分库分表-分页</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/DAL/dbReadWrite/" class="">数据库-读写分离</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/DAL/dbSharding/" class="">分库分表</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/DAL/mybatisInteceptor/" class="">Mybatis Plugin Inteceptor</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-8f9194d3152193bbfc8d905f93eb7238" class="toggle"  />
    <label for="section-8f9194d3152193bbfc8d905f93eb7238" class="flex justify-between">
      <a role="button" class="">分布式锁</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/redisDistKey/" class="">Redis 分布式锁</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/zookeeperDistributedLock/" class="">Zookeeper-分布式锁</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/distributedLock/" class="">分布式锁</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-35ef217d212df8f7f126510047a2ffcd" class="toggle"  />
    <label for="section-35ef217d212df8f7f126510047a2ffcd" class="flex justify-between">
      <a role="button" class="">其他</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/transactionSeata/" class="">Seata 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/tomcat/" class="">Tomcat总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/timedTask/" class="">延迟消息 时间轮</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/id/" class="">分布式ID生成 发号器</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/%E5%85%B6%E4%BB%96/zookeeper/" class="">Zookeeper-总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/www6vMiddleware/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Redis LazyFree</h3>

  <label for="toc-control">
    
    <img src="/www6vMiddleware/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#场景-1">场景 [1]</a></li>
        <li><a href="#相关配置">相关配置</a></li>
        <li><a href="#源代码">源代码</a></li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><p></p>
<!-- more -->
<h2 id="场景-1">
  场景 [1]
  <a class="anchor" href="#%e5%9c%ba%e6%99%af-1">#</a>
</h2>
<ul>
<li>场景一：客户端执行的<strong>显示删除/清除命令</strong>，比如 del，flushdb 等；</li>
<li>场景二：某些指令带有的隐式删除命令，比如 move , rename 等；</li>
<li>场景三：到达<strong>过期</strong>时间的数据需要删除；</li>
<li>场景四：使用内存达到 maxmemory 后被选出来要<strong>淘汰</strong>的数据需要删除；</li>
<li>场景五：在主从同步全量同步阶段，从库收到主库的 RDB 文件后要先删除现有的数据再加载 RDB 文件；</li>
</ul>
<h2 id="相关配置">
  相关配置
  <a class="anchor" href="#%e7%9b%b8%e5%85%b3%e9%85%8d%e7%bd%ae">#</a>
</h2>
<pre tabindex="0"><code>惰性删除相 关的配置项

lazyfree-lazy-eviction：对应缓存淘汰时的数据删除场景。
lazyfree-lazy-expire：对应过期 key 的删除场景。
lazyfree-lazy-server-del：对应会隐式进行删除操作的 server 命令执行场景。
replica-lazy-flush：对应从节点完成全量同步后，删除原有旧数据的场景。
</code></pre><h2 id="源代码">
  源代码
  <a class="anchor" href="#%e6%ba%90%e4%bb%a3%e7%a0%81">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>evict.c
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">freeMemoryIfNeeded</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*......*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Finally remove the selected key. */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (bestkey) {
</span></span><span style="display:flex;"><span>            db <span style="color:#f92672">=</span> server.db<span style="color:#f92672">+</span>bestdbid;
</span></span><span style="display:flex;"><span>            robj <span style="color:#f92672">*</span>keyobj <span style="color:#f92672">=</span> <span style="color:#a6e22e">createStringObject</span>(bestkey,<span style="color:#a6e22e">sdslen</span>(bestkey));
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">propagateExpire</span>(db,keyobj,server.lazyfree_lazy_eviction);  <span style="color:#960050;background-color:#1e0010">###</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* We compute the amount of memory freed by db*Delete() alone.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * It is possible that actually the memory needed to propagate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * the DEL in AOF and replication link is greater than the one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * we are freeing removing the key, but we can&#39;t account for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * that otherwise we would never exit the loop.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * AOF and Output buffer memory will be freed eventually so
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * we only care about memory used by the key space. */</span>
</span></span><span style="display:flex;"><span>            delta <span style="color:#f92672">=</span> (<span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>) <span style="color:#a6e22e">zmalloc_used_memory</span>();    <span style="color:#75715e">//获取当前内存使用量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">latencyStartMonitor</span>(eviction_latency);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (server.lazyfree_lazy_eviction)   <span style="color:#75715e">/////. 如果 lazyfree_lazy_eviction 被设置为 1，也就是启用了缓存淘汰时的惰性删除，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">dbAsyncDelete</span>(db,keyobj);        <span style="color:#75715e">/////.  那么，删除操作对应的命令就是 UNLINK；
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">dbSyncDelete</span>(db,keyobj);         <span style="color:#75715e">/////.  否则的话，命令就是 DEL。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/*......*/</span>
</span></span><span style="display:flex;"><span>            delta <span style="color:#f92672">-=</span> (<span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>) <span style="color:#a6e22e">zmalloc_used_memory</span>();   <span style="color:#75715e">///根据当前内存使用量计算数据删除前后释放....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            mem_freed <span style="color:#f92672">+=</span> delta;    <span style="color:#75715e">//更新已释放的内存量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">/*......*/</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>db.c <span style="color:#960050;background-color:#1e0010">###</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Propagate expires into slaves and the AOF file.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * When a key expires in the master, a DEL operation for this key is sent
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * to all the slaves and the AOF file if enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * This way the key expiry is centralized in one place, and since both
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * AOF and the master-&gt;slave link guarantee operation ordering, everything
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * will be consistent even if we allow write operations against expiring
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * keys. */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">propagateExpire</span>(redisDb <span style="color:#f92672">*</span>db, robj <span style="color:#f92672">*</span>key, <span style="color:#66d9ef">int</span> lazy) {
</span></span><span style="display:flex;"><span>    robj <span style="color:#f92672">*</span>argv[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    argv[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> lazy <span style="color:#f92672">?</span> shared.unlink : shared.del;    <span style="color:#75715e">// 如果server启用了lazyfree-lazy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> key;                <span style="color:#75715e">//被淘汰的key对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">incrRefCount</span>(argv[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">incrRefCount</span>(argv[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (server.aof_state <span style="color:#f92672">!=</span> AOF_OFF)   <span style="color:#75715e">///  是否启用了 AOF 日志 /// 如果启用了AOF日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">feedAppendOnlyFile</span>(server.delCommand,db<span style="color:#f92672">-&gt;</span>id,argv,<span style="color:#ae81ff">2</span>);  <span style="color:#75715e">// 把被淘汰 key 的删除操作记录到 AOF 文件中，以保证后续使用 AOF 文件进行 Redis 数据库恢复时，可以和恢复前保持一致
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">replicationFeedSlaves</span>(server.slaves,db<span style="color:#f92672">-&gt;</span>id,argv,<span style="color:#ae81ff">2</span>);   <span style="color:#75715e">//// 把删除操作同步给从节点，以保证主从节点的数据一致
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">decrRefCount</span>(argv[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">decrRefCount</span>(argv[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code>子操作一

子操作一：将被淘汰的键值对从哈希表中去除，这里的哈希表既可能是设置了过期 key
的哈希表，也可能是全局哈希表。
子操作二：释放被淘汰键值对所占用的内存空间。
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">子操作一</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Search and remove an element. This is an helper function for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * dictDelete() and dictUnlink(), please check the top comment
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * of those functions. */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> dictEntry <span style="color:#f92672">*</span><span style="color:#a6e22e">dictGenericDelete</span>(dict <span style="color:#f92672">*</span>d, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>key, <span style="color:#66d9ef">int</span> nofree) {
</span></span><span style="display:flex;"><span>... ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    h <span style="color:#f92672">=</span> <span style="color:#a6e22e">dictHashKey</span>(d, key);  <span style="color:#75715e">//计算key的哈希值 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (table <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; table <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>; table<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        idx <span style="color:#f92672">=</span> h <span style="color:#f92672">&amp;</span> d<span style="color:#f92672">-&gt;</span>ht[table].sizemask;  <span style="color:#75715e">//根据key的哈希值获取它所在的哈希桶编号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        he <span style="color:#f92672">=</span> d<span style="color:#f92672">-&gt;</span>ht[table].table[idx];   <span style="color:#75715e">//获取key所在哈希桶的第一个哈希项
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        prevHe <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span>(he) {        <span style="color:#75715e">//在哈希桶中逐一查找被删除的key是否存在
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (key<span style="color:#f92672">==</span>he<span style="color:#f92672">-&gt;</span>key <span style="color:#f92672">||</span> <span style="color:#a6e22e">dictCompareKeys</span>(d, key, he<span style="color:#f92672">-&gt;</span>key)) {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">/* Unlink the element from the list */</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//如果找见被删除key了，那么将它从哈希桶的链表中去除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (prevHe)
</span></span><span style="display:flex;"><span>                    prevHe<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> he<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                    d<span style="color:#f92672">-&gt;</span>ht[table].table[idx] <span style="color:#f92672">=</span> he<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>nofree) {        <span style="color:#75715e">//如果要同步删除，那么就释放key和value的内存空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">dictFreeKey</span>(d, he);     <span style="color:#75715e">//调用dictFreeKey释放
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">dictFreeVal</span>(d, he);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">zfree</span>(he);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                d<span style="color:#f92672">-&gt;</span>ht[table].used<span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> he;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            prevHe <span style="color:#f92672">=</span> he;
</span></span><span style="display:flex;"><span>            he <span style="color:#f92672">=</span> he<span style="color:#f92672">-&gt;</span>next;           <span style="color:#75715e">//当前key不是要查找的key，再找下一个
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        ......
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Remove an element, returning DICT_OK on success or DICT_ERR if the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * element was not found. */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">dictDelete</span>(dict <span style="color:#f92672">*</span>ht, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>key) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dictGenericDelete</span>(ht,key,<span style="color:#ae81ff">0</span>) <span style="color:#f92672">?</span> DICT_OK : DICT_ERR;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Remove an element from the table, but without actually releasing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * the key, value and dictionary entry. The dictionary entry is returned
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * if the element was found (and unlinked from the table), and the user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * should later call `dictFreeUnlinkedEntry()` with it in order to release it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Otherwise if the key is not found, NULL is returned.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * This function is useful when we want to remove something from the hash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * table but want to use its value before actually deleting the entry.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Without this function the pattern would require two lookups:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  entry = dictFind(...);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  // Do something with entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  dictDelete(dictionary,entry);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Thanks to this function it is possible to avoid this, and use
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * instead:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * entry = dictUnlink(dictionary,entry);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * // Do something with entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * dictFreeUnlinkedEntry(entry); // &lt;- This does not need to lookup again.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>dictEntry <span style="color:#f92672">*</span><span style="color:#a6e22e">dictUnlink</span>(dict <span style="color:#f92672">*</span>ht, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>key) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dictGenericDelete</span>(ht,key,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">子操作二</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">基于异步删除的数据淘汰</span>
</span></span><span style="display:flex;"><span>dbAsyncDelete
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Delete a key, value, and associated expiration entry if any, from the DB.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * If there are enough allocations to free the value object may be put into
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * a lazy free list instead of being freed synchronously. The lazy free list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * will be reclaimed in a different bio.c thread. */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define LAZYFREE_THRESHOLD 64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">dbAsyncDelete</span>(redisDb <span style="color:#f92672">*</span>db, robj <span style="color:#f92672">*</span>key) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Deleting an entry from the expires dict will not free the sds of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * the key, because it is shared with the main dictionary. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">dictSize</span>(db<span style="color:#f92672">-&gt;</span>expires) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#a6e22e">dictDelete</span>(db<span style="color:#f92672">-&gt;</span>expires,key<span style="color:#f92672">-&gt;</span>ptr);  <span style="color:#75715e">/// 在过期 key 的哈希表中同步删除被淘汰的键值对
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* If the value is composed of a few allocations, to free in a lazy way
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * is actually just slower... So under a certain limit we just free
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * the object synchronously. */</span>
</span></span><span style="display:flex;"><span>    dictEntry <span style="color:#f92672">*</span>de <span style="color:#f92672">=</span> <span style="color:#a6e22e">dictUnlink</span>(db<span style="color:#f92672">-&gt;</span>dict,key<span style="color:#f92672">-&gt;</span>ptr);  <span style="color:#75715e">/// 在全局哈希表中异步删除被淘汰的键值对
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (de) {
</span></span><span style="display:flex;"><span>        robj <span style="color:#f92672">*</span>val <span style="color:#f92672">=</span> <span style="color:#a6e22e">dictGetVal</span>(de);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">size_t</span> free_effort <span style="color:#f92672">=</span> <span style="color:#a6e22e">lazyfreeGetFreeEffort</span>(val);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* If releasing the object is too much work, do it in the background
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * by adding the object to the lazy free list.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * Note that if the object is shared, to reclaim it now it is not
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * possible. This rarely happens, however sometimes the implementation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * of parts of the Redis core may call incrRefCount() to protect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * objects, and then call dbDelete(). In this case we&#39;ll fall
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * through and reach the dictFreeUnlinkedEntry() call, that will be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * equivalent to just calling decrRefCount(). */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (free_effort <span style="color:#f92672">&gt;</span> LAZYFREE_THRESHOLD <span style="color:#f92672">&amp;&amp;</span> val<span style="color:#f92672">-&gt;</span>refcount <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) { <span style="color:#75715e">/// 计算释放被淘汰键值对内存空间的开销///当被淘汰键值对是包含超过 64 个元素的集合类型时
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">atomicIncr</span>(lazyfree_objects,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">bioCreateBackgroundJob</span>(BIO_LAZY_FREE,val,NULL,NULL); <span style="color:#75715e">/// 会调用 bioCreateBackgroundJob 函数，来实际创建后台任务执行惰性删除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">dictSetVal</span>(db<span style="color:#f92672">-&gt;</span>dict,de,NULL);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Release the key-val pair, or just the key if we set the val
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * field to NULL in order to lazy free it later. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (de) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dictFreeUnlinkedEntry</span>(db<span style="color:#f92672">-&gt;</span>dict,de);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (server.cluster_enabled) <span style="color:#a6e22e">slotToKeyDel</span>(key);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Return the amount of work needed in order to free an object.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * The return value is not always the actual number of allocations the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * object is compoesd of, but a number proportional to it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * For strings the function always returns 1.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * For aggregated objects represented by hash tables or other data structures
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * the function just returns the number of elements the object is composed of.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Objects composed of single allocations are always reported as having a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * single item even if they are actually logical composed of multiple
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * elements.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * For lists the function returns the number of elements in the quicklist
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * representing the list. */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">size_t</span> <span style="color:#a6e22e">lazyfreeGetFreeEffort</span>(robj <span style="color:#f92672">*</span>obj) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (obj<span style="color:#f92672">-&gt;</span>type <span style="color:#f92672">==</span> OBJ_LIST) {
</span></span><span style="display:flex;"><span>        quicklist <span style="color:#f92672">*</span>ql <span style="color:#f92672">=</span> obj<span style="color:#f92672">-&gt;</span>ptr;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ql<span style="color:#f92672">-&gt;</span>len;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (obj<span style="color:#f92672">-&gt;</span>type <span style="color:#f92672">==</span> OBJ_SET <span style="color:#f92672">&amp;&amp;</span> obj<span style="color:#f92672">-&gt;</span>encoding <span style="color:#f92672">==</span> OBJ_ENCODING_HT) {
</span></span><span style="display:flex;"><span>        dict <span style="color:#f92672">*</span>ht <span style="color:#f92672">=</span> obj<span style="color:#f92672">-&gt;</span>ptr;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dictSize</span>(ht);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (obj<span style="color:#f92672">-&gt;</span>type <span style="color:#f92672">==</span> OBJ_ZSET <span style="color:#f92672">&amp;&amp;</span> obj<span style="color:#f92672">-&gt;</span>encoding <span style="color:#f92672">==</span> OBJ_ENCODING_SKIPLIST){
</span></span><span style="display:flex;"><span>        zset <span style="color:#f92672">*</span>zs <span style="color:#f92672">=</span> obj<span style="color:#f92672">-&gt;</span>ptr;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> zs<span style="color:#f92672">-&gt;</span>zsl<span style="color:#f92672">-&gt;</span>length;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (obj<span style="color:#f92672">-&gt;</span>type <span style="color:#f92672">==</span> OBJ_HASH <span style="color:#f92672">&amp;&amp;</span> obj<span style="color:#f92672">-&gt;</span>encoding <span style="color:#f92672">==</span> OBJ_ENCODING_HT) {
</span></span><span style="display:flex;"><span>        dict <span style="color:#f92672">*</span>ht <span style="color:#f92672">=</span> obj<span style="color:#f92672">-&gt;</span>ptr;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dictSize</span>(ht);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (obj<span style="color:#f92672">-&gt;</span>type <span style="color:#f92672">==</span> OBJ_STREAM) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">size_t</span> effort <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        stream <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> obj<span style="color:#f92672">-&gt;</span>ptr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Make a best effort estimate to maintain constant runtime. Every macro
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * node in the Stream is one allocation. */</span>
</span></span><span style="display:flex;"><span>        effort <span style="color:#f92672">+=</span> s<span style="color:#f92672">-&gt;</span>rax<span style="color:#f92672">-&gt;</span>numnodes;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Every consumer group is an allocation and so are the entries in its
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * PEL. We use size of the first group&#39;s PEL as an estimate for all
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * others. */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (s<span style="color:#f92672">-&gt;</span>cgroups) {
</span></span><span style="display:flex;"><span>            raxIterator ri;
</span></span><span style="display:flex;"><span>            streamCG <span style="color:#f92672">*</span>cg;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raxStart</span>(<span style="color:#f92672">&amp;</span>ri,s<span style="color:#f92672">-&gt;</span>cgroups);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raxSeek</span>(<span style="color:#f92672">&amp;</span>ri,<span style="color:#e6db74">&#34;^&#34;</span>,NULL,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* There must be at least one group so the following should always
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * work. */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">serverAssert</span>(<span style="color:#a6e22e">raxNext</span>(<span style="color:#f92672">&amp;</span>ri));
</span></span><span style="display:flex;"><span>            cg <span style="color:#f92672">=</span> ri.data;
</span></span><span style="display:flex;"><span>            effort <span style="color:#f92672">+=</span> <span style="color:#a6e22e">raxSize</span>(s<span style="color:#f92672">-&gt;</span>cgroups)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#a6e22e">raxSize</span>(cg<span style="color:#f92672">-&gt;</span>pel));
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raxStop</span>(<span style="color:#f92672">&amp;</span>ri);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> effort;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">/* Everything else is a single allocation. */</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code>子操作二

基于同步删除的数据淘汰
dbSyncDelete
</code></pre><h2 id="参考">
  参考
  <a class="anchor" href="#%e5%8f%82%e8%80%83">#</a>
</h2>
<ol>
<li><a href="https://blog.csdn.net/LIFE_PLAN/article/details/127786442">redis惰性删除 lazy free 源码剖析，干货满满</a></li>
</ol>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#场景-1">场景 [1]</a></li>
        <li><a href="#相关配置">相关配置</a></li>
        <li><a href="#源代码">源代码</a></li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












