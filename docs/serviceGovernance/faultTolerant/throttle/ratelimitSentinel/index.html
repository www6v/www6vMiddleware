<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Sentinel#限流 API [4]#定义资源 资源：可以是任何东西，一个服务，服务里的方法，甚至是一段代码。 try (Entry entry = SphU.entry(&#34;HelloWorld&#34;)) { // Your business logic here. System.out.println(&#34;hello world&#34;); } catch (BlockException e) { // Handle rejected request. e.printStackTrace(); } // try-with-resources auto exit @SentinelResource(&#34;HelloWorld&#34;) public void helloWorld() { // 资源中的逻辑 System.out.println(&#34;hello world&#34;); } 定义规则 规则：Sentinel 支持以下几种规则： 流量控制规则、熔断降级规则、系统保护规则、来源访问控制规则和 热点参数规则。 private void initSystemRule() { List&lt;SystemRule&gt; rules = new ArrayList&lt;&gt;(); SystemRule rule = new SystemRule(); // 规则 rule.setHighestSystemLoad(10); rules.add(rule); SystemRuleManager.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://www6v.github.io/www6vMiddleware/docs/serviceGovernance/faultTolerant/throttle/ratelimitSentinel/">
  <meta property="og:site_name" content="中间件">
  <meta property="og:title" content="流量治理-Sentinel">
  <meta property="og:description" content="Sentinel#限流 API [4]#定义资源 资源：可以是任何东西，一个服务，服务里的方法，甚至是一段代码。 try (Entry entry = SphU.entry(&#34;HelloWorld&#34;)) { // Your business logic here. System.out.println(&#34;hello world&#34;); } catch (BlockException e) { // Handle rejected request. e.printStackTrace(); } // try-with-resources auto exit @SentinelResource(&#34;HelloWorld&#34;) public void helloWorld() { // 资源中的逻辑 System.out.println(&#34;hello world&#34;); } 定义规则 规则：Sentinel 支持以下几种规则： 流量控制规则、熔断降级规则、系统保护规则、来源访问控制规则和 热点参数规则。 private void initSystemRule() { List&lt;SystemRule&gt; rules = new ArrayList&lt;&gt;(); SystemRule rule = new SystemRule(); // 规则 rule.setHighestSystemLoad(10); rules.add(rule); SystemRuleManager.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="website">
<title>流量治理-Sentinel | 中间件</title>
<link rel="icon" href="/www6vMiddleware/favicon.png" >
<link rel="manifest" href="/www6vMiddleware/manifest.json">
<link rel="canonical" href="https://www6v.github.io/www6vMiddleware/docs/serviceGovernance/faultTolerant/throttle/ratelimitSentinel/">
<link rel="stylesheet" href="/www6vMiddleware/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css" integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin="anonymous">
  <script defer src="/www6vMiddleware/fuse.min.js"></script>
  <script defer src="/www6vMiddleware/en.search.min.b4c267b63bd2d996b53b827d5c011566787dec45d285c3f0bde3536ffcdedffc.js" integrity="sha256-tMJntjvS2Za1O4J9XAEVZnh97EXShcPwveNTb/ze3/w=" crossorigin="anonymous"></script>

  

<link rel="alternate" type="application/rss+xml" href="https://www6v.github.io/www6vMiddleware/docs/serviceGovernance/faultTolerant/throttle/ratelimitSentinel/index.xml" title="中间件" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/www6vMiddleware/"><span>中间件</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li>
          
  
  

  
    <span>(服务治理)</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Overview</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Overview/microservice/" class="">微服务 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Overview/soaFeature/" class="">分布式服务框架功能</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>API Gateway</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/API-Gateway/apiGatawaySpringGateway/" class="">API 网关-SpringCloud Gateway</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/API-Gateway/apiGatawayApisix/" class="">API 网关-apisix</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/API-Gateway/apiGateway/" class="">API Gateway网关</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Config &amp; Discovery</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/ConfigDiscovery/soaDiscovery/" class="">服务发现</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/ConfigDiscovery/config/" class="">服务治理-分布式配置</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>负载均衡</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/loadBalance/loadBalance/" class="">负载均衡-算法</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/loadBalance/nginxOptimize/" class="">Nginx优化</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/loadBalance/nginx/" class="">Nginx总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>线程模型</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/threadModel/jsfThreadModel/" class="">京东服务框架JSF服务提供者线程模型</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>容错&amp;限流</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>容错</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/faultTolerant/soaTolerateFramework/" class="">容错框架</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/faultTolerant/soaTimeout/" class="">超时和重试 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/faultTolerant/soaTolerate/" class="">分布式服务框架 容错机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>限流</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/throttle/ratelimitSentinel/" class="active">流量治理-Sentinel</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/throttle/ratelimit/" class="">限流-总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/soaGracefulStart/" class="">优雅启动</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/faultTolerant/soaGracefulClose/" class="">优雅关闭</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Spring Cloud</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springTransactionInvalid/" class="">Spring  Transaction  失效</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springCloud/" class="">SpringCloud</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springboot/" class="">SpringBoot</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Springcloud/springTransaction/" class="">Spring事务</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>灰度发布</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/Gray/apiGatewayGray/" class="">API 网关-灰度发布</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>安全</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/security/soaAuth/" class="">服务治理-鉴权</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/serviceGovernance/security/securityOAuth2/" class="">安全-OAuth2</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>(消息系统)</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Overview</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Overview/mq/" class="">消息中间件总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Overview/mqCompare/" class="">MQ总结(Kafka, Rocketmq, Rabbitmq)</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Overview/mqOrdering/" class="">消息系统 顺序消息</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Kafka</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafka/" class="">Kafka总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaProducer/" class="">Kafka Producer生产者</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaConsumer/" class="">Kafka消费者总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaRebalance/" class="">Kafka消费者-Rebalance机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaReliability/" class="">Kafka 可靠性总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaIndex/" class="">Kafka 索引</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaZeroCopy/" class="">Kafka-ZeroCopy</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaController/" class="">Kafka Controller-控制器</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaReplica/" class="">Kafka Replication-副本机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaElection/" class="">Kafka 中的选主</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaQ-A/" class="">Kafka  Q&amp;A</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/message/Kafka/kafkaTransaction/" class="">Kafka 幂等性和事务</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>(关系型数据库)</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>单机</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlTransactionAndLock/" class="">MySQL 事务-隔离性</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlUpdate/" class="">MySQL中的SQL更新语句</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlReliability/" class="">MySQL的主从 高可用 容灾</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlIndex/" class="">MySQL的索引和优化</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlTransaction/" class="">MySQL事务-总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlLog/" class="">MySQL Logs</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlDeadLock/" class="">MySQL  锁和死锁</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vMiddleware/docs/RMDB/%E5%8D%95%E6%9C%BA/mysqlMasterSlaveDelay/" class="">MySQL 主从延迟</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/www6vMiddleware/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>流量治理-Sentinel</h3>

  <label for="toc-control">
    
    <img src="/www6vMiddleware/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#sentinel">Sentinel</a>
      <ul>
        <li>
          <ul>
            <li><a href="#限流-api-4">限流 API [4]</a></li>
            <li><a href="#限流-类型-2">限流 类型 [2]</a></li>
            <li><a href="#分布式限流-1">分布式限流 [1]</a></li>
            <li><a href="#滑动窗口--2">滑动窗口  [2]</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#sentinel-vs-hystrix-vs-resilience4j-3">Sentinel vs. Hystrix vs. resilience4j [3]</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><p></p>
<!-- more -->
<h1 id="sentinel">
  Sentinel
  <a class="anchor" href="#sentinel">#</a>
</h1>
<h3 id="限流-api-4">
  限流 API [4]
  <a class="anchor" href="#%e9%99%90%e6%b5%81-api-4">#</a>
</h3>
<ol>
<li>定义资源
资源：可以是任何东西，一个服务，服务里的方法，甚至是一段代码。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> (Entry entry <span style="color:#f92672">=</span> SphU.<span style="color:#a6e22e">entry</span>(<span style="color:#e6db74">&#34;HelloWorld&#34;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Your business logic here.</span>
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;hello world&#34;</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">catch</span> (BlockException e) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Handle rejected request.</span>
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// try-with-resources auto exit</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#a6e22e">@SentinelResource</span>(<span style="color:#e6db74">&#34;HelloWorld&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">helloWorld</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 资源中的逻辑</span>
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;hello world&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="2">
<li>定义规则
规则：Sentinel 支持以下几种规则：
流量控制规则、熔断降级规则、系统保护规则、来源访问控制规则和 热点参数规则。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initSystemRule</span>() {
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>SystemRule<span style="color:#f92672">&gt;</span> rules <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    SystemRule rule <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SystemRule();  <span style="color:#75715e">// 规则</span>
</span></span><span style="display:flex;"><span>    rule.<span style="color:#a6e22e">setHighestSystemLoad</span>(10);
</span></span><span style="display:flex;"><span>    rules.<span style="color:#a6e22e">add</span>(rule);
</span></span><span style="display:flex;"><span>    SystemRuleManager.<span style="color:#a6e22e">loadRules</span>(rules);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span>FlowRuleManager.<span style="color:#a6e22e">loadRules</span>(List<span style="color:#f92672">&lt;</span>FlowRule<span style="color:#f92672">&gt;</span> rules); <span style="color:#75715e">// 流控规则</span>
</span></span><span style="display:flex;"><span>DegradeRuleManager.<span style="color:#a6e22e">loadRules</span>(List<span style="color:#f92672">&lt;</span>DegradeRule<span style="color:#f92672">&gt;</span> rules); <span style="color:#75715e">// 降级规则</span>
</span></span><span style="display:flex;"><span>SystemRuleManager.<span style="color:#a6e22e">loadRules</span>(List<span style="color:#f92672">&lt;</span>SystemRule<span style="color:#f92672">&gt;</span> rules); <span style="color:#75715e">// 系统规则</span>
</span></span><span style="display:flex;"><span>AuthorityRuleManager.<span style="color:#a6e22e">loadRules</span>(List<span style="color:#f92672">&lt;</span>AuthorityRule<span style="color:#f92672">&gt;</span> rules); <span style="color:#75715e">// 授权规则</span>
</span></span></code></pre></div><h3 id="限流-类型-2">
  限流 类型 [2]
  <a class="anchor" href="#%e9%99%90%e6%b5%81-%e7%b1%bb%e5%9e%8b-2">#</a>
</h3>
<ul>
<li>直接失败  [滑动时间窗口]</li>
<li>Warmup 预热 [令牌桶算法]</li>
<li>限流排队  [漏桶算法]</li>
</ul>
<h3 id="分布式限流-1">
  分布式限流 [1]
  <a class="anchor" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e9%99%90%e6%b5%81-1">#</a>
</h3>
<h3 id="滑动窗口--2">
  滑动窗口  [2]
  <a class="anchor" href="#%e6%bb%91%e5%8a%a8%e7%aa%97%e5%8f%a3--2">#</a>
</h3>
<p><img src="./images/SlidingWindows.png" alt="SlidingWindows" /></p>
<p>核心代码  LeapArray.java</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * Get bucket item at given time from the array.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * (1) Bucket is absent, then just create a new bucket and CAS update to circular array.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * (2) Bucket is up-to-date, then just return the bucket.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * (3) Bucket is deprecated, then reset current bucket.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>            WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> old <span style="color:#f92672">=</span> array.<span style="color:#a6e22e">get</span>(idx);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (old <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) { <span style="color:#75715e">/// 初始化一个窗口</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *     B0       B1      B2    NULL      B4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * ||_______|_______|_______|_______|_______||___
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * 200     400     600     800     1000    1200  timestamp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *                             ^
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *                          time=888
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *            bucket is empty, so create new and update
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * If the old bucket is absent, then we create a new bucket at {@code windowStart},
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * then try to update circular array via a CAS operation. Only one thread can
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * succeed to update, while other threads yield its time slice.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 */</span>
</span></span><span style="display:flex;"><span>                WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> window <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(windowLengthInMs, windowStart, newEmptyBucket(timeMillis));
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (array.<span style="color:#a6e22e">compareAndSet</span>(idx, <span style="color:#66d9ef">null</span>, window)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Successfully updated, return the created bucket.</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> window;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Contention failed, the thread will yield its time slice to wait for bucket available.</span>
</span></span><span style="display:flex;"><span>                    Thread.<span style="color:#a6e22e">yield</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (windowStart <span style="color:#f92672">==</span> old.<span style="color:#a6e22e">windowStart</span>()) { <span style="color:#75715e">/// 返回老的窗口</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *     B0       B1      B2     B3      B4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * ||_______|_______|_______|_______|_______||___
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * 200     400     600     800     1000    1200  timestamp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *                             ^
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *                          time=888
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *            startTime of Bucket 3: 800, so it&#39;s up-to-date
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * If current {@code windowStart} is equal to the start timestamp of old bucket,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * that means the time is within the bucket, so directly return the bucket.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 */</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> old;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (windowStart <span style="color:#f92672">&gt;</span> old.<span style="color:#a6e22e">windowStart</span>()) {  <span style="color:#75715e">/// 滚动: 重置老的窗口, 增加新的窗口</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *   (old)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *             B0       B1      B2    NULL      B4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * |_______||_______|_______|_______|_______|_______||___
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * ...    1200     1400    1600    1800    2000    2200  timestamp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *                              ^
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *                           time=1676
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *          startTime of Bucket 2: 400, deprecated, should be reset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * If the start timestamp of old bucket is behind provided time, that means
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * the bucket is deprecated. We have to reset the bucket to current {@code windowStart}.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * Note that the reset and clean-up operations are hard to be atomic,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * so we need a update lock to guarantee the correctness of bucket update.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * The update lock is conditional (tiny scope) and will take effect only when
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * bucket is deprecated, so in most cases it won&#39;t lead to performance loss.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 */</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (updateLock.<span style="color:#a6e22e">tryLock</span>()) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// Successfully get the update lock, now we reset the bucket.</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> resetWindowTo(old, windowStart);  <span style="color:#75715e">/// 清零重置old窗口</span>
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>                        updateLock.<span style="color:#a6e22e">unlock</span>();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Contention failed, the thread will yield its time slice to wait for bucket available.</span>
</span></span><span style="display:flex;"><span>                    Thread.<span style="color:#a6e22e">yield</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (windowStart <span style="color:#f92672">&lt;</span> old.<span style="color:#a6e22e">windowStart</span>()) {  <span style="color:#75715e">/// 时钟回拨</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Should not go through here, as the provided time is already behind.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(windowLengthInMs, windowStart, newEmptyBucket(timeMillis));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h1 id="sentinel-vs-hystrix-vs-resilience4j-3">
  Sentinel vs. Hystrix vs. resilience4j [3]
  <a class="anchor" href="#sentinel-vs-hystrix-vs-resilience4j-3">#</a>
</h1>
<table>
<thead>
<tr>
<th></th>
<th>Sentinel</th>
<th>Hystrix</th>
<th>resilience4j</th>
</tr>
</thead>
<tbody>
<tr>
<td>隔离策略</td>
<td>信号量隔离（并发线程数限流）</td>
<td>线程池隔离/信号量隔离</td>
<td>信号量隔离</td>
</tr>
<tr>
<td>熔断降级策略</td>
<td>基于响应时间、异常比率、异常数等</td>
<td>异常比率模式、超时熔断</td>
<td>基于异常比率、响应时间</td>
</tr>
<tr>
<td>实时统计实现</td>
<td>滑动窗口（LeapArray）</td>
<td>滑动窗口（基于 RxJava）</td>
<td>Ring Bit Buffer</td>
</tr>
<tr>
<td>动态规则配置</td>
<td>支持<a href="https://github.com/alibaba/Sentinel/wiki/%e5%8a%a8%e6%80%81%e8%a7%84%e5%88%99%e6%89%a9%e5%b1%95#datasource-%e6%89%a9%e5%b1%95">多种配置源</a></td>
<td>支持多种数据源</td>
<td>有限支持</td>
</tr>
<tr>
<td>扩展性</td>
<td>丰富的 SPI 扩展接口</td>
<td>插件的形式</td>
<td>接口的形式</td>
</tr>
<tr>
<td>基于注解的支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>限流</td>
<td>基于 QPS，支持基于调用关系的限流</td>
<td>有限的支持</td>
<td>Rate Limiter</td>
</tr>
<tr>
<td>集群流量控制</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>流量整形</td>
<td>支持预热模式、匀速排队模式等多种复杂场景</td>
<td>不支持</td>
<td>简单的 Rate Limiter 模式</td>
</tr>
<tr>
<td>系统自适应保护</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>控制台</td>
<td>提供开箱即用的控制台，可配置规则、查看秒级监控、机器发现等</td>
<td>简单的监控查看</td>
<td>不提供控制台，可对接其它监控系统</td>
</tr>
<tr>
<td>多语言支持</td>
<td>Java / C++</td>
<td>Java</td>
<td>Java</td>
</tr>
<tr>
<td>开源社区状态</td>
<td>活跃</td>
<td>停止维护</td>
<td>较活跃</td>
</tr>
</tbody>
</table>
<h1 id="参考">
  参考
  <a class="anchor" href="#%e5%8f%82%e8%80%83">#</a>
</h1>
<ol>
<li>
<p><a href="https://sentinelguard.io/zh-cn/docs/cluster-flow-control.html">集群流量控制</a></p>
</li>
<li>
<p><a href="https://www.bilibili.com/video/BV1MP4y1176q?p=11">【图灵学院】2022最新B站独家分布式限流算法原理与应用讲解视频短合集</a>   V</p>
</li>
<li>
<p><a href="https://github.com/alibaba/Sentinel/wiki/%E5%B8%B8%E7%94%A8%E9%99%90%E6%B5%81%E9%99%8D%E7%BA%A7%E7%BB%84%E4%BB%B6%E5%AF%B9%E6%AF%94">常用限流降级组件对比</a> Sentinel vs. Hystrix</p>
</li>
<li>
<p><a href="https://www.cnblogs.com/crazymakercircle/p/14285001.html">sentinel （史上最全+入门教程）</a> ***</p>
</li>
<li>
<p><a href="https://github.com/www6v/StabilityGuide/blob/master/docs/prevention/resilience/%E6%B5%81%E6%8E%A7%E9%99%8D%E7%BA%A7%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md">流控降级最佳实践</a>  阿里 未</p>
</li>
<li>
<p>{% post_link &lsquo;ratelimit&rsquo; %}  self</p>
</li>
</ol>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#sentinel">Sentinel</a>
      <ul>
        <li>
          <ul>
            <li><a href="#限流-api-4">限流 API [4]</a></li>
            <li><a href="#限流-类型-2">限流 类型 [2]</a></li>
            <li><a href="#分布式限流-1">分布式限流 [1]</a></li>
            <li><a href="#滑动窗口--2">滑动窗口  [2]</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#sentinel-vs-hystrix-vs-resilience4j-3">Sentinel vs. Hystrix vs. resilience4j [3]</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












